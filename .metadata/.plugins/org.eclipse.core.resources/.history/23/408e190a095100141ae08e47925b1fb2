package com.mredrock.util;

import java.util.Timer;
import java.util.TimerTask;

import android.app.Activity;
import android.util.Log;
import android.view.MotionEvent;
import android.view.VelocityTracker;
import android.view.View;
import android.view.animation.AccelerateDecelerateInterpolator;
import android.view.animation.Interpolator;

public class ActivitySlider{
	private Activity act;
	private View rootView;
	private Timer timer;
	private VelocityTracker verTracker; 
	
	private int duration = 500;
	private Interpolator interpolator = new AccelerateDecelerateInterpolator();

	
	/**
	 * å½“æ»‘åŠ¨é?åº¦è¶…è¿‡æ­¤å€¼å¾—æ—¶å?å…³é—­activity
	 */
	public int VELOCITY_CLOSE = 1000;
	/**
	 * å½“æ»‘åŠ¨é?åº¦è¶…è¿‡æ­¤å€¼å¾—æ—¶å?å›å¤activity
	 */
	private final static int VELOCITY_BACK= -100;
	
	/**
	 * activityå…³é—­æ—¶çš„åŠ¨ç”»é€Ÿåº¦ä¸æ‰‹æŒ‡é?åº¦çš„æ¯”ä¾‹[0~1]
	 */
	public float VELOCITY_RATIO_ANIM= 0.5f;
	/**
	 * å½“æ»‘åŠ¨è¶…è¿‡å±å¹•å¤šå°‘æ¯”ä¾‹çš„æ—¶å?å…³é—­activity
	 */
	public float OFFSET_RATIO_CLOSE= 0.4f;
	/**
	 * æ‰‹åŠ¿ç§»åŠ¨è¶…è¿‡æ­¤èŒƒå›´å¼€å§‹è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨æ­¤èŒƒå›´å†…å¿½ç•?
	 */
	private final static int JUDGEEDGE= 12;
	
	private int state;
	private int width;
	private int beginTouchX;
	private int beginTouchY;
	private float deltaX;
	private float deltaY;
	private int startX;
	
	/**
	 * ä»æŒ‰ä¸‹åˆ°å¼¹èµ·çš„ä¸€å¥—åŠ¨ä½œæ˜¯å¦æœ‰æ•?
	 */
	private boolean isActionAvailable=false;
	/**
	 * çŠ¶æ?ï¼šç©ºé—? æ»‘åŠ¨   æŒ‰ä¸‹    åŠ¨ç”»    
	 */
	public final static int STATE_FREE=0;
	public final static int STATE_SLIDING=1;
	public final static int STATE_TOUCHING=2;
	public final static int STATE_ANIMING=3;

	public ActivitySlider(Activity act){
		this.act=act;
		this.width=Util.getScreenWidth(act);
		rootView=act.getWindow().getDecorView();
		timer=new Timer();
	}
	
	/**
	 * åœ¨Activityçš„dispatchTouchEventä¸­è°ƒç”¨ã?
	 * @param ev
	 * @return
	 */
	public boolean onTouch(MotionEvent ev){
		switch(ev.getAction()){
		case MotionEvent.ACTION_DOWN:
			if(state==STATE_FREE){
				verTracker= VelocityTracker.obtain(); 

				beginTouchX=(int) ev.getRawX();
				beginTouchY=(int) ev.getRawY();

				state=STATE_TOUCHING;
				isActionAvailable=true;
				return false;
			}else{
				isActionAvailable=false;
				return true;
			}
			
		case MotionEvent.ACTION_MOVE:

			if(!isActionAvailable){
				return true;
			}
			verTracker.addMovement(ev);
			deltaX=Math.abs(ev.getRawX()-beginTouchX);
			deltaY=Math.abs(ev.getRawY()-beginTouchY);
			//Log.i("test", "beginTouchX"+beginTouchX+"ev.getRawX()"+ev.getRawX()+"deltaX:"+deltaX
			//		+ "beginTouchY"+beginTouchY+"ev.getRawY()"+ev.getRawY()+";deltaY"+deltaY);
			if(ev.getRawX()-beginTouchX<0){//å·¦ç§»å¿½ç•¥
				beginTouchX=(int) ev.getRawX();
				return false;
			}
			switch(state){
			case STATE_TOUCHING:
				if(deltaX < JUDGEEDGE && deltaY < JUDGEEDGE){//å°çŸ©å½¢ä¸­ä¸å¤„ç?
					return false;
				}else{//é¦–æ¬¡ç¦»å¼€å°çŸ©å½¢ï¼Œåˆ¤æ–­æ˜¯æ¨ªç?§»è¿˜æ˜¯ç«–ç€ç§?
					if(deltaY/deltaX<1){//æ¨ªå‘ç§»åŠ¨,å¼?§‹æ»‘åŠ¨activityï¼Œå¹¶é”å®šçŠ¶æ?
						rootView.scrollTo(beginTouchX-(int) ev.getRawX(), 0);
						state=STATE_SLIDING;
						ev.setAction(MotionEvent.ACTION_CANCEL);//ç¬¬ä¸€æ¬¡æ¨ªå‘ç§»åŠ¨ï¼Œå–æ¶ˆå­viewçš„æŒ‰ä¸‹çŠ¶æ€?
						return false;
					}else{//çºµå‘ç§»åŠ¨ï¼Œæ•°ç§»æ”¾è¡Œæ­¤åŠ¨ä½œï¼Œå¹¶é”å®šçŠ¶æ?
						state=STATE_FREE;
						return false;
					}
				}
			case STATE_SLIDING:
				rootView.scrollTo(beginTouchX-(int) ev.getRawX(), 0);
				return true;
			case STATE_FREE:
				return false;
			}
			break;
			
		case MotionEvent.ACTION_UP:
			if(!isActionAvailable){
				return true;
			}
			verTracker.computeCurrentVelocity(1000);
			if(state==STATE_SLIDING){
				startX=(int) (beginTouchX-ev.getRawX());
				state=STATE_ANIMING;
				
				if(startX>0){//å·¦ç§»èƒ¡ç•¥
					state=STATE_FREE;
					rootView.scrollTo(0, 0);
				}
				if(verTracker.getXVelocity()<VELOCITY_BACK){//é€Ÿåº¦ä¸ºè´Ÿæ•°ï¼Œå‘å·¦æ»‘çš„å¤„ç†
					Log.i("MotionEvent", "å‘å·¦ç§?);
					AnimToBack((int)(verTracker.getXVelocity()*VELOCITY_RATIO_ANIM));
						
				}else if(verTracker.getXVelocity()>VELOCITY_CLOSE){//é€Ÿåº¦å¤§äºç•Œé™é€Ÿåº¦
					Log.i("MotionEvent", "å‘å³ç§»ï¼Œä¸”é?åº?1000");
					if(-startX>JUDGEEDGE){
						AnimToClose((int)(verTracker.getXVelocity()*VELOCITY_RATIO_ANIM));
					}else{
						AnimToBack();
					}
				}else {//é€Ÿåº¦[-100,ç•Œå®šé€Ÿåº¦]
					Log.i("MotionEvent", "å‘å³ç§»ï¼Œä¸”é?åº?ç•Œå®šé€Ÿåº¦");
					
					if(-startX>(width*OFFSET_RATIO_CLOSE)){//æ»‘åŠ¨ä½ç½®>ç•Œå®šå±å¹•
						Log.i("test", "ä½ç§»å¤§äºå±å¹•");
						AnimToClose();
					}else{//æ»‘åŠ¨ä½ç½®[0,ç•Œå®šå±å¹•]
						Log.i("MotionEvent", "ä½ç§»å°äºå±å¹•");
						AnimToBack();
					}
				}
			}else{
				state=STATE_FREE;
			}
			verTracker.recycle();
			verTracker=null;
			break;
		default:
			Log.i("MotionEvent", "æœªè¯†åˆ«action"+ev.getAction());
		}
		return false;
	}
	
	private void AnimToClose(){
		timer.schedule(new ActivitySlideTask(rootView, startX, -width, duration, interpolator, new Runnable(){

			@Override
			public void run() {	
				act.finish();
				timer.purge();
			}

		}),0,1); 
	}
	
	private void AnimToClose(int velocity){
		timer.schedule(new ActivitySlideTask(rootView, startX, -width, velocity, new Runnable(){

			@Override
			public void run() {	
				act.finish();
				timer.purge();
			}

		}),0,1); 
	}
	
	private void AnimToBack(){
		timer.schedule(new ActivitySlideTask(rootView, startX, 0, duration, interpolator, new Runnable(){

			@Override
			public void run() {	
				timer.purge();
				state=STATE_FREE;
			}

		}),0,1); 
	}
	
	private void AnimToBack(int velocity){
		timer.schedule(new ActivitySlideTask(rootView, startX, 0,velocity, new Runnable(){

			@Override
			public void run() {	
				timer.purge();
				state=STATE_FREE;
			}

		}),0,1); 
	}
	
	 /**
	  * åœ¨éœ€è¦å…³é—­çš„æ—¶å?è°ƒç”¨ï¼Œactivityå°†æ»‘åŠ¨å…³é—?
	  */
	public void onClose(){
		if(state==STATE_FREE){
			state=STATE_SLIDING;
			if(timer==null){
			}
			timer.schedule(new ActivitySlideTask(rootView, 0, -width, duration, interpolator, new Runnable(){

				@Override
				public void run() {	
					act.finish();
					timer.purge();
					state=STATE_FREE;
				}
		    	 
		     }),0,1);
		}
	}
	
	/**
	 * è·å–çŠ¶æ?
	 * @return
	 */
	public int getState() {
		return state;
	}
	/**
	 * è·å–åŠ¨ç”»æŒç»­æ—¶é—´
	 */
	public int getDuration() {
		return duration;
	}
	
	/**
	 * è®¾ç½®åŠ¨ç”»æŒç»­æ—¶é—´ï¼Œé»˜è®?000ms
	 */
	public void setDuration(int duration) {
		this.duration = duration==0?1000:duration;
	}
	
	/**
	 * è®¾ç½®é€Ÿåº¦é€‰æ‹©å™¨ï¼Œé»˜è®¤åŒ??ç§»åŠ¨
	 * @return
	 */
	public void setInterpolator(Interpolator interpolator) {
		this.interpolator = interpolator;
	}

}

/**
 * åŠ¨ç”»çº¿ç¨‹
 * @author	æœ±æ™¨æ›?
 * @time 2014å¹?æœ?æ—?ä¸‹åˆ12:27:51
 * @function
 */
class ActivitySlideTask extends TimerTask {
	/**
	 * è¢«ç§»åŠ¨çš„ä¸»è§†å›?
	 */
	private View rootView;
	/**
	 * èµ·å§‹æ—¶é—´
	 */
	private long starTtime;
	
	/**
	 * è¿åŠ¨æ—¶é—´
	 */
	private int duration;
	
	/**
	 * èµ·å§‹ä½ç½®
	 */
	private int startX;
	
	/**
	 * ç»“æŸä½ç½®
	 */
	private int endX;
	
	/**
	 * ç»“æŸåè¿è¡Œçš„Runnable
	 */
	private Runnable endRunnable;
	
	/**
	 * å³æ—¶çš„è¿›åº¦[0~1]
	 */
	private float normalizedTime;
	
	/**
	 * è¿åŠ¨é€Ÿåº¦æ’å?å™?
	 */
	private Interpolator interpolator;
	
	/**
	 * å³æ—¶çš„ä½ç½?
	 */
	private int mPosX;
	
	public ActivitySlideTask(View rootView,int startX,int endX,int duration,Interpolator interpolator,Runnable endRunnable){
		this.rootView=rootView;
		this.starTtime=System.currentTimeMillis();
		this.startX=startX;
		this.endX=endX;
		this.duration=duration;
		this.endRunnable=endRunnable;
		this.interpolator=interpolator;
	}
	
	public ActivitySlideTask(View rootView,int startX,int endX,int velocity,Runnable endRunnable){
		this.rootView=rootView;
		this.starTtime=System.currentTimeMillis();
		this.startX=startX;
		this.endX=endX;
		this.endRunnable=endRunnable;
		this.interpolator=null;
		this.duration=Math.abs((endX-startX)*1000/velocity);
		this.duration=this.duration>600?600:this.duration;
	}
	/**
	 * å‘¨æœŸ1æ¯«ç§’å¾ªç¯æ‰§è¡Œæ­¤Runnableã€‚å°†rootViewçš„ä½ç½®ä¸€ç‚¹ä¸€ç‚¹ç§»åŠ?
	 */
	@Override
	public void run() {
		normalizedTime=(float)(System.currentTimeMillis()-starTtime)/duration;
		if(normalizedTime>=1){
			Log.i("test", endX+"");
			rootView.scrollTo(endX, 0);
			if(endRunnable!=null){
    		 endRunnable.run();
			}
    		this.cancel();
    	 }else{
    	        if(interpolator==null)mPosX = (int) (startX + ((endX - startX ) * normalizedTime));
    	        else mPosX = (int) (startX + ((endX - startX ) * interpolator.getInterpolation(normalizedTime)));
    	        rootView.scrollTo(mPosX, 0);
    	 } 
	}

}
